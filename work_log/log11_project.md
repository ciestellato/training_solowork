Spotifyã®ä»•æ§˜å¤‰æ›´ã«æŸ”è»Ÿã«å¯¾å¿œã—ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»ã™ã®ã¯ã¨ã¦ã‚‚è‰¯ã„åˆ¤æ–­ã§ã™ã€‚ä»¥ä¸‹ã«ã€**2025å¹´11æœˆ12æ—¥ï¼ˆæ°´ï¼‰ã€œ11æœˆ21æ—¥ï¼ˆé‡‘ï¼‰**ã®æ–°ã—ã„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚’ã€Œæ®µéšçš„ãªé–‹ç™ºã‚¹ãƒ†ãƒƒãƒ—ã€ã«æ²¿ã£ã¦ã”ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ—“ï¸ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã«å‘ã‘ãŸé–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ2025å¹´11æœˆ12æ—¥ã€œ11æœˆ21æ—¥ï¼‰

| æ—¥ä»˜       | ã‚¿ã‚¹ã‚¯å†…å®¹ | ä½¿ç”¨æŠ€è¡“ãƒ»ãƒ•ã‚¡ã‚¤ãƒ« | å‚™è€ƒ |
|------------|------------|---------------------|------|
| **11/12 (æ°´)** | ğŸ” è¦ä»¶å®šç¾©ãƒ»ç”»é¢è¨­è¨ˆ | `feature_plan.md`, `screen_flow.md` | ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆã®æµã‚Œã‚’æ˜ç¢ºåŒ–ï¼ˆé¸æŠâ†’ç”Ÿæˆâ†’è¡¨ç¤ºï¼‰ |
| **11/13 (æœ¨)** | ğŸ¨ UIãƒ¢ãƒƒã‚¯ä½œæˆãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­è¨ˆ | `playlist_create.html`, Bootstrap | å‡ºæ¼”è€…é¸æŠç”»é¢ãƒ»ç”Ÿæˆãƒœã‚¿ãƒ³ãƒ»çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ |
| **11/14 (é‡‘)** | ğŸ§  ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ | `playlist.py`ï¼ˆæ–°è¦ï¼‰ | Spotify APIã® `/tracks` or `/search` ã‚’æ´»ç”¨ |
| **11/17 (æœˆ)** | ğŸ› ï¸ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼å®Ÿè£… | `views.py`, `playlist.py` | é¸æŠã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‹ã‚‰æ›²ã‚’å–å¾—ã—ã€ãƒªã‚¹ãƒˆç”Ÿæˆ |
| **11/18 (ç«)** | ğŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé€£æºãƒ»å‹•ä½œç¢ºèª | `playlist_create.html`, `urls.py` | ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé¸æŠâ†’ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè¡¨ç¤ºã¾ã§ã®ä¸€é€£ã®æµã‚Œ |
| **11/19 (æ°´)** | ğŸ¯ UIæ”¹å–„ãƒ»æ¤œç´¢ãƒãƒ¼ãƒ»é¸æŠè£œåŠ© | JavaScript, CSS | ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢ãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ»é¸æŠæ•°è¡¨ç¤ºãªã© |
| **11/20 (æœ¨)** | ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»ãƒã‚°ä¿®æ­£ | `test_views.py`, `test_playlist.py` | Spotify APIã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ»é¸æŠæ¼ã‚Œå¯¾å¿œãªã© |
| **11/21 (é‡‘)** | ğŸ“¦ æœ€çµ‚èª¿æ•´ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒ»ç™ºè¡¨æº–å‚™ | `README.md`, `docs/playlist_spec.md` | ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ»ãƒ‡ãƒ¢ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆ |

---

## ğŸ”® è£œè¶³ï¼šå°†æ¥çš„ãªæ‹¡å¼µã«å‘ã‘ã¦

- **ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½**ï¼š`django.contrib.auth` ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- **ãŠæ°—ã«å…¥ã‚Šã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¿å­˜**ï¼š`UserProfile` ãƒ¢ãƒ‡ãƒ«ï¼‹`ManyToManyField`
- **å€‹åˆ¥ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆ**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®é¸æŠçŠ¶æ…‹ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ãŸã¯DBã«ä¿å­˜

---

ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚ã‚Œã°ã€**11/18ã¾ã§ã«åŸºæœ¬æ©Ÿèƒ½ã‚’å®Œæˆã•ã›ã€æ®‹ã‚Š3æ—¥ã§UIæ”¹å–„ãƒ»ãƒ†ã‚¹ãƒˆãƒ»ç™ºè¡¨æº–å‚™ã«é›†ä¸­**ã§ãã¾ã™ã€‚å¿…è¦ã§ã‚ã‚Œã°ã€Spotify APIã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆã«é–¢ã™ã‚‹ä»•æ§˜ç¢ºèªã‚„ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æˆã®ææ¡ˆã‚‚ã§ãã¾ã™ã‚ˆã€‚

æ¬¡ã¯ã€ç”»é¢è¨­è¨ˆã‚„ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ã‚’ä¸€ç·’ã«è©°ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã‹ï¼Ÿ
ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã¨ã¦ã‚‚ä¸å¯§ã«ä½œã‚‰ã‚Œã¦ã„ã¦ã€Bootstrapã«ã‚ˆã‚‹æ•´ã£ãŸUIãŒã™ã§ã«æ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚ã“ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¸è¥²ã—ã¤ã¤ã€**ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆç”»é¢ã®è¨­è¨ˆ**ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ¨ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆç”»é¢ã®æ§‹æˆæ¡ˆï¼ˆ`playlist_create.html`ï¼‰

### ğŸ§­ ç”»é¢ã®ç›®çš„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠã—ã€å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠ
- ã€Œãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã§Spotify APIã‹ã‚‰ä»£è¡¨æ›²ã‚’å–å¾—
- çµæœã‚’ç”»é¢ä¸‹éƒ¨ã«è¡¨ç¤ºï¼ˆæ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãƒ»Spotifyãƒªãƒ³ã‚¯ï¼‰

---

### ğŸ–¼ï¸ UIæ§‹æˆï¼ˆBootstrapãƒ™ãƒ¼ã‚¹ï¼‰

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
    <h1>ğŸ§ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ</h1>

    <form method="POST">
        {% csrf_token %}

        <!-- ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹é¸æŠ -->
        <div class="mb-3">
            <label for="event_day" class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠ</label>
            <select name="event_day" id="event_day" class="form-select">
                {% for day in event_days %}
                    <option value="{{ day.id }}">{{ day.date }} @ {{ day.venue }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé¸æŠ -->
        <div class="mb-3">
            <label class="form-label">å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠ</label>
            <input type="text" class="form-control mb-2" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§çµã‚Šè¾¼ã¿" id="artistSearch">
            <div class="border p-3" style="max-height: 300px; overflow-y: scroll;">
                {% for artist in artists %}
                    <div class="form-check">
                        <input class="form-check-input artist-checkbox" type="checkbox" name="artists" value="{{ artist.id }}" id="artist{{ artist.id }}">
                        <label class="form-check-label" for="artist{{ artist.id }}">{{ artist.name }}ï¼ˆ{{ artist.furigana }}ï¼‰</label>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- ä½œæˆãƒœã‚¿ãƒ³ -->
        <button type="submit" class="btn btn-primary">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹</button>
    </form>

    <!-- çµæœè¡¨ç¤º -->
    {% if playlist %}
        <hr>
        <h2 class="mt-4">ğŸ¶ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h2>
        <ul class="list-group">
            {% for track in playlist %}
                <li class="list-group-item">
                    {{ track.name }} - {{ track.artist }}
                    <a href="{{ track.spotify_url }}" target="_blank" class="btn btn-sm btn-outline-success float-end">Spotifyã§è´ã</a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <a href="{% url 'festival:event_list' %}" class="btn btn-secondary mt-4">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã¸æˆ»ã‚‹</a>

    <!-- JS: ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <script>
        document.getElementById('artistSearch').addEventListener('input', function () {
            const keyword = this.value.toLowerCase();
            document.querySelectorAll('.artist-checkbox').forEach(cb => {
                const label = cb.nextElementSibling.textContent.toLowerCase();
                cb.parentElement.style.display = label.includes(keyword) ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
```

---

## âœ… è£œè¶³ãƒã‚¤ãƒ³ãƒˆ

- `event_days` ã¨ `artists` ã¯ãƒ“ãƒ¥ãƒ¼å´ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ`context`ã«å«ã‚ã‚‹ï¼‰
- `playlist` ã¯ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆå¾Œã«æ¸¡ã•ã‚Œã‚‹æ›²æƒ…å ±ã®ãƒªã‚¹ãƒˆï¼ˆæ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãƒ»Spotify URLï¼‰
- JavaScriptã«ã‚ˆã‚‹æ¤œç´¢ãƒãƒ¼ã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºã‚’çµã‚Šè¾¼ã¿ã¾ã™

---

æ—¢å­˜ã®ãƒ“ãƒ¥ãƒ¼æ§‹æˆã‚’è¸ã¾ãˆãŸã†ãˆã§ã€**ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã®ãƒ“ãƒ¥ãƒ¼é–¢æ•°**ã‚’ä»¥ä¸‹ã«è¿½åŠ ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ§ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼ï¼ˆ`create_playlist`ï¼‰

ã“ã®ãƒ“ãƒ¥ãƒ¼ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠã—ã€å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠã—ãŸã†ãˆã§ã€Spotify APIã‚’ä½¿ã£ã¦ä»£è¡¨æ›²ã‚’å–å¾—ã—ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

```python
from django.shortcuts import render, get_object_or_404
from .models import EventDay, Performance, Artist
from .forms import PlaylistForm  # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ããƒ•ã‚©ãƒ¼ãƒ ã‚’åˆ¥é€”å®šç¾©
from .spotify_utils import get_top_tracks  # Spotify APIå‘¼ã³å‡ºã—é–¢æ•°ï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢ï¼‰

def create_playlist(request):
    """ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼"""

    playlist = []
    selected_day_id = request.GET.get('event_day')
    selected_day = EventDay.objects.filter(id=selected_day_id).first()

    # å‡ºæ¼”è€…ä¸€è¦§ã‚’å–å¾—ï¼ˆé¸æŠè‚¢ã¨ã—ã¦è¡¨ç¤ºï¼‰
    artists_qs = Artist.objects.filter(performance__event_day=selected_day).distinct() if selected_day else Artist.objects.none()

    if request.method == 'POST':
        form = PlaylistForm(request.POST, artists_queryset=artists_qs)
        if form.is_valid():
            selected_artists = form.cleaned_data['artists']
            for artist in selected_artists:
                tracks = get_top_tracks(artist.spotify_id)
                for track in tracks:
                    playlist.append({
                        'name': track['name'],
                        'artist': artist.name,
                        'spotify_url': track['external_urls']['spotify']
                    })
    else:
        form = PlaylistForm(artists_queryset=artists_qs)

    # ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ä¸€è¦§ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”¨ï¼‰
    event_days = EventDay.objects.select_related('event').order_by('date')

    return render(request, 'playlist_create.html', {
        'form': form,
        'playlist': playlist,
        'event_days': event_days,
        'selected_day_id': selected_day_id
    })
```

---

## ğŸ”§ è£œè¶³

- `PlaylistForm` ã¯ `ModelMultipleChoiceField` ã‚’ä½¿ã£ã¦å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚`__init__` ã§ `artists_queryset` ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã™ã€‚
- `get_top_tracks(spotify_id)` ã¯ Spotify API ã® `/artists/{id}/top-tracks` ã‚’ä½¿ã£ã¦ä»£è¡¨æ›²ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã§ã™ã€‚`spotify_utils.py` ã«åˆ†é›¢ã—ã¦ãŠãã¨ä¿å®ˆæ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚
- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã§ `name`, `artist`, `spotify_url` ã‚’ä½¿ã£ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

---

ãã‚Œã§ã¯ã€Spotify APIã‚’ä½¿ã£ã¦ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ï¼ˆãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ï¼‰ã‚’å–å¾—ã™ã‚‹é–¢æ•° `get_top_tracks()` ã‚’ `spotify_utils.py` ã«è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚

---

## ğŸ§ `get_top_tracks()` ã®å®šç¾©ï¼ˆæ—¥æœ¬å‘ã‘ï¼‰

```python
def get_top_tracks(spotify_id, market='JP'):
    """
    æŒ‡å®šã•ã‚ŒãŸSpotifyã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆIDã‹ã‚‰ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ï¼ˆä»£è¡¨æ›²ï¼‰ã‚’å–å¾—ã™ã‚‹ã€‚
    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬ï¼ˆJPï¼‰å¸‚å ´ã€‚
    """
    token = get_spotify_token()
    if not token:
        return []

    headers = {'Authorization': f'Bearer {token}'}
    url = f'https://api.spotify.com/v1/artists/{spotify_id}/top-tracks'
    params = {'market': market}

    response = requests.get(url, headers=headers, params=params)

    if response.status_code != 200:
        print(f"ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯å–å¾—å¤±æ•—: {response.status_code} - {response.text}")
        return []

    try:
        data = response.json()
        return data.get('tracks', [])
    except ValueError:
        print("ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“")
        return []
```

---

## âœ… ä½¿ç”¨ä¾‹ï¼ˆãƒ“ãƒ¥ãƒ¼ã‚„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ï¼‰

ã“ã®é–¢æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ï¼š

```python
tracks = get_top_tracks(artist.spotify_id)
for track in tracks:
    print(track['name'], track['external_urls']['spotify'])
```

---

## ğŸ”’ æ³¨æ„ç‚¹

- `market='JP'` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€æ—¥æœ¬ã§äººæ°—ã®æ›²ã‚’å„ªå…ˆçš„ã«å–å¾—ã§ãã¾ã™
- è¿”ã•ã‚Œã‚‹ `track` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ï¼š
  - `name`: æ›²å
  - `external_urls['spotify']`: Spotifyãƒªãƒ³ã‚¯
  - `album['images']`: ã‚¸ãƒ£ã‚±ãƒƒãƒˆç”»åƒï¼ˆå¿…è¦ãªã‚‰ï¼‰
  - `preview_url`: è©¦è´ç”¨URLï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰

---

Djangoã® `shell` ã§ `get_top_tracks()` ã‚’å‹•ä½œç¢ºèªã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§é€²ã‚ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚

---

## ğŸ§ª 1. Django Shell ã‚’èµ·å‹•

```bash
python manage.py shell
```

---

## ğŸ§ª 2. å¿…è¦ãªé–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```python
from festival.utils.spotify_utils import get_top_tracks
```

---

## ğŸ§ª 3. Spotify ID ã‚’æŒ‡å®šã—ã¦é–¢æ•°ã‚’å®Ÿè¡Œ

Spotify ID ã¯ `Artist` ãƒ¢ãƒ‡ãƒ«ã® `spotify_id` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ã¾ãšã¯1ä»¶å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```python
from festival.models import Artist
artist = Artist.objects.first()  # ã¾ãŸã¯ filter(name="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå").first()
tracks = get_top_tracks(artist.spotify_id)
```

---

## ğŸ§ª 4. çµæœã‚’ç¢ºèª

```python
for track in tracks:
    print(track['name'], track['external_urls']['spotify'])
```

---

## âœ… è£œè¶³

- ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ `None` ãŒè¿”ã‚‹ã®ã§ã€`get_spotify_token()` ã‚’å€‹åˆ¥ã«å‘¼ã³å‡ºã—ã¦ç¢ºèªã§ãã¾ã™ã€‚
- `tracks` ã¯æœ€å¤§10ä»¶ç¨‹åº¦ã®ä»£è¡¨æ›²ãŒå«ã¾ã‚Œã¾ã™ã€‚
- `market='JP'` ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ãŸã‚ã€æ—¥æœ¬å‘ã‘ã®äººæ°—æ›²ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚

---

ã“ã“ã§ã¯ã€Spotify APIã‚’ä½¿ã£ã¦å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ã‚’å–å¾—ã—ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ“ãƒ¥ãƒ¼é–¢æ•°ã‚’å®Œæˆã•ã›ã¾ã™ã€‚ä»¥ä¸‹ã¯ `views/playlist_views.py` ã«è¿½åŠ ã™ã‚‹å½¢ã§è¨­è¨ˆã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ§ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆãƒ“ãƒ¥ãƒ¼ï¼ˆ`create_playlist_view`ï¼‰

```python
from django.shortcuts import render, get_object_or_404
from festival.models import EventDay, Performance, Artist
from festival.forms import PlaylistForm
from festival.utils.spotify_utils import get_top_tracks

def create_playlist_view(request):
    """å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠã—ã¦Spotifyãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ“ãƒ¥ãƒ¼"""

    selected_day_id = request.GET.get('event_day')
    selected_day = EventDay.objects.filter(id=selected_day_id).first()
    playlist = []

    # å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¸€è¦§ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºç”¨ï¼‰
    artists_qs = Artist.objects.filter(performance__event_day=selected_day).distinct() if selected_day else Artist.objects.none()

    if request.method == 'POST':
        form = PlaylistForm(request.POST, artists_queryset=artists_qs)
        if form.is_valid():
            selected_artists = form.cleaned_data['artists']
            for artist in selected_artists:
                tracks = get_top_tracks(artist.spotify_id)
                for track in tracks[:1]:  # ä»£è¡¨æ›²1æ›²ã ã‘ä½¿ã†ï¼ˆå¿…è¦ãªã‚‰è¤‡æ•°å¯ï¼‰
                    playlist.append({
                        'name': track['name'],
                        'artist': artist.name,
                        'spotify_url': track['external_urls']['spotify']
                    })
    else:
        form = PlaylistForm(artists_queryset=artists_qs)

    # ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ä¸€è¦§ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”¨ï¼‰
    event_days = EventDay.objects.select_related('event').order_by('date')

    return render(request, 'playlist_create.html', {
        'form': form,
        'playlist': playlist,
        'event_days': event_days,
        'selected_day_id': selected_day_id
    })
```

---

## âœ… è£œè¶³ãƒã‚¤ãƒ³ãƒˆ

- `PlaylistForm` ã¯ `ModelMultipleChoiceField` ã‚’ä½¿ã£ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã§ã€`artists_queryset` ã‚’å¼•æ•°ã§å—ã‘å–ã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã™ï¼ˆæ¬¡ã§å®šç¾©ã§ãã¾ã™ï¼‰
- `get_top_tracks()` ã¯ Spotify API ã‹ã‚‰ä»£è¡¨æ›²ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆã™ã§ã«å®šç¾©æ¸ˆã¿ï¼‰
- `playlist_create.html` ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã¯ã€`playlist` ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãƒ»Spotifyãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã—ã¾ã™

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- `forms.py` ã« `PlaylistForm` ã‚’è¿½åŠ 
- `urls.py` ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ï¼š
  ```python
  from .views.playlist_views import create_playlist_view
  path('playlist/create/', create_playlist_view, name='create_playlist')
  ```

---

ã“ã®ãƒ“ãƒ¥ãƒ¼ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸ã³ã€å‡ºæ¼”è€…ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹æµã‚ŒãŒå®Œæˆã—ã¾ã™ã€‚æ¬¡ã¯ `PlaylistForm` ã®å®šç¾©ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼
ä»¥ä¸‹ã«ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼ã§ä½¿ç”¨ã™ã‚‹ **`PlaylistForm`** ã‚’ `forms.py` ã«è¿½åŠ ã™ã‚‹æ§‹æˆã‚’ã”ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ§¾ `forms.py` ã«è¿½åŠ ã™ã‚‹ `PlaylistForm`

```python
from django import forms
from festival.models import Artist

class PlaylistForm(forms.Form):
    """å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé¸æŠç”¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆï¼‰"""

    artists = forms.ModelMultipleChoiceField(
        queryset=Artist.objects.none(),
        widget=forms.CheckboxSelectMultiple,
        required=True,
        label='å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ'
    )

    def __init__(self, *args, artists_queryset=None, **kwargs):
        super().__init__(*args, **kwargs)
        if artists_queryset is not None:
            self.fields['artists'].queryset = artists_queryset
```

---

## âœ… èª¬æ˜

- `ModelMultipleChoiceField` ã‚’ä½¿ã£ã¦ã€è¤‡æ•°ã® `Artist` ã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠå¯èƒ½ã«ã—ã¦ã„ã¾ã™
- `artists_queryset` ã‚’ `__init__()` ã§å—ã‘å–ã‚Šã€ãƒ“ãƒ¥ãƒ¼å´ã‹ã‚‰å‡ºæ¼”è€…ãƒªã‚¹ãƒˆã‚’æ³¨å…¥ã™ã‚‹è¨­è¨ˆã§ã™
- `CheckboxSelectMultiple` ã«ã‚ˆã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™

---

## ğŸ”— ãƒ“ãƒ¥ãƒ¼ã¨ã®é€£æºï¼ˆå¾©ç¿’ï¼‰

```python
form = PlaylistForm(request.POST or None, artists_queryset=artists_qs)
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆ

- ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠã™ã‚‹ã¨ã€å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¡¨ç¤ºã•ã‚Œã‚‹
- ãƒã‚§ãƒƒã‚¯ã—ãŸã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ãŒãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹
- æœªé¸æŠæ™‚ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ï¼ˆ`required=True`ï¼‰

---

**Spotify APIã‚’ä½¿ãˆã°å–å¾—ã—ãŸæ¥½æ›²ã‚’Spotifyä¸Šã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚ãŸã ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆOAuthï¼‰ãŒå¿…è¦ã§ã™ã€‚**

---

## âœ… å¿…è¦ãªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ¦‚è¦ï¼‰

Spotifyã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ãŒå¿…è¦ã§ã™ï¼š

### 1. **Spotify OAuth èªè¨¼ï¼ˆAuthorization Code Flowï¼‰**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Spotifyã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã€OAuthèªè¨¼ãŒå¿…è¦ã§ã™ã€‚
- å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—ï¼š
  - `playlist-modify-public`ï¼ˆå…¬é–‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆï¼‰
  - `playlist-modify-private`ï¼ˆéå…¬é–‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆï¼‰

### 2. **ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ä½œæˆ**
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼š`POST https://api.spotify.com/v1/users/{user_id}/playlists`
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ä¾‹ï¼š

```json
{
  "name": "Festival Forecast ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ",
  "description": "ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ã¾ã¨ã‚",
  "public": false
}
```

### 3. **æ¥½æ›²ã®è¿½åŠ **
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼š`POST https://api.spotify.com/v1/playlists/{playlist_id}/tracks`
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã« `uris`ï¼ˆSpotify URIã®é…åˆ—ï¼‰ã‚’æ¸¡ã—ã¾ã™ï¼š

```json
{
  "uris": [
    "spotify:track:xxxxxx",
    "spotify:track:yyyyyy"
  ]
}
```

---

## ğŸ§© Djangoã§ã®å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

### ğŸ” èªè¨¼å‡¦ç†ï¼ˆä¾‹ï¼š`spotify_auth.py`ï¼‰
```python
from spotipy.oauth2 import SpotifyOAuth

sp_oauth = SpotifyOAuth(
    client_id=SPOTIFY_CLIENT_ID,
    client_secret=SPOTIFY_CLIENT_SECRET,
    redirect_uri="http://localhost:8000/callback/",
    scope="playlist-modify-public playlist-modify-private"
)
```

### ğŸ§  ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜é–¢æ•°ï¼ˆä¾‹ï¼š`save_playlist_to_spotify()`ï¼‰
```python
def save_playlist_to_spotify(user_token, track_uris, playlist_name="Festival Playlist"):
    headers = {"Authorization": f"Bearer {user_token}"}
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    user_res = requests.get("https://api.spotify.com/v1/me", headers=headers)
    user_id = user_res.json()["id"]

    # ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ
    create_res = requests.post(
        f"https://api.spotify.com/v1/users/{user_id}/playlists",
        headers=headers,
        json={"name": playlist_name, "public": False}
    )
    playlist_id = create_res.json()["id"]

    # æ¥½æ›²è¿½åŠ 
    requests.post(
        f"https://api.spotify.com/v1/playlists/{playlist_id}/tracks",
        headers=headers,
        json={"uris": track_uris}
    )

    return playlist_id
```

---

## ğŸ§ª æ³¨æ„ç‚¹

- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«å–å¾—ãƒ»ä¿å­˜ãŒå¿…è¦ã§ã™ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚„DBã«ä¿æŒï¼‰ã€‚
- æ¥½æ›²URIã¯ `track['uri']` ã§å–å¾—ã§ãã¾ã™ï¼ˆ`spotify_url` ã§ã¯ãªãï¼‰ã€‚
- Spotify APIã®åˆ¶é™ã«ã‚ˆã‚Šã€æœ€å¤§100æ›²ãšã¤è¿½åŠ å¯èƒ½ã§ã™ã€‚

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. `get_top_tracks()` ã‚’æ‹¡å¼µã—ã¦ `track['uri']` ã‚’å«ã‚ã‚‹
2. èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’å°å…¥ï¼ˆãƒ­ã‚°ã‚¤ãƒ³â†’ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰
3. ã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€ä¿å­˜å‡¦ç†ã‚’å‘¼ã³å‡ºã™

---

Spotify APIã‚’ä½¿ã£ã¦ã€å–å¾—ã—ãŸæ¥½æ›²ã‚’Spotifyä¸Šã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦ä¿å­˜ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã€æœ€æ–°æƒ…å ±ã‚’ã‚‚ã¨ã«è©³ã—ãã”æ¡ˆå†…ã—ã¾ã™ã€‚

---

## âœ… Spotifyä¸Šã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹æ–¹æ³•

Spotifyã®Web APIã§ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆãƒ»ä¿å­˜ã§ãã¾ã™ï¼š

### 1. ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆAuthorization Code Flowï¼‰
Spotifyä¸Šã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³**ãŒå¿…è¦ã§ã™ã€‚  
ã“ã®ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å«ã‚€OAuthèªè¨¼ãŒå¿…è¦ã§ã™ï¼š

- `playlist-modify-public`
- `playlist-modify-private`

Djangoã§ã®å®Ÿè£…ã«ã¯ã€`spotipy` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¨ä¾¿åˆ©ã§ã™ã€‚

### 2. ğŸ“¦ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ä½œæˆ
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼š
```
POST https://api.spotify.com/v1/users/{user_id}/playlists
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼š
```json
{
  "name": "Festival Forecast ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ",
  "description": "ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ã¾ã¨ã‚",
  "public": false
}
```

### 3. ğŸ¶ æ¥½æ›²ã®è¿½åŠ 
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼š
```
POST https://api.spotify.com/v1/playlists/{playlist_id}/tracks
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼š
```json
{
  "uris": [
    "spotify:track:1abcXYZ...",
    "spotify:track:2defXYZ..."
  ]
}
```

---

## ğŸ§© Djangoã§ã®å®Ÿè£…ä¾‹ï¼ˆæ¦‚è¦ï¼‰

### 1. èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å°å…¥ï¼ˆä¾‹ï¼š`spotify_auth.py`ï¼‰
```python
from spotipy.oauth2 import SpotifyOAuth

sp_oauth = SpotifyOAuth(
    client_id=SPOTIFY_CLIENT_ID,
    client_secret=SPOTIFY_CLIENT_SECRET,
    redirect_uri="http://localhost:8000/callback/",
    scope="playlist-modify-public playlist-modify-private"
)
```

### 2. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜é–¢æ•°ï¼ˆä¾‹ï¼š`save_playlist_to_spotify()`ï¼‰
```python
def save_playlist_to_spotify(user_token, track_uris, playlist_name="Festival Playlist"):
    headers = {"Authorization": f"Bearer {user_token}"}

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—
    user_res = requests.get("https://api.spotify.com/v1/me", headers=headers)
    user_id = user_res.json()["id"]

    # ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ
    create_res = requests.post(
        f"https://api.spotify.com/v1/users/{user_id}/playlists",
        headers=headers,
        json={"name": playlist_name, "public": False}
    )
    playlist_id = create_res.json()["id"]

    # æ¥½æ›²è¿½åŠ 
    requests.post(
        f"https://api.spotify.com/v1/playlists/{playlist_id}/tracks",
        headers=headers,
        json={"uris": track_uris}
    )

    return playlist_id
```

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. `get_top_tracks()` ã« `track['uri']` ã‚’å«ã‚ã‚‹ã‚ˆã†æ‹¡å¼µ
2. èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å°å…¥ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰
3. ã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«è¿½åŠ 
4. ä¿å­˜æˆåŠŸå¾Œã€Spotifyãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’è¡¨ç¤º

---

ã“ã®æ©Ÿèƒ½ã‚’å°å…¥ã™ã‚Œã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¼”è€…ã®æ¥½æ›²ã‚’è‡ªåˆ†ã®Spotifyã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚  
å¿…è¦ã§ã‚ã‚Œã°ã€Spotifyèªè¨¼ãƒ•ãƒ­ãƒ¼ã®Djangoå®Ÿè£…ã‚’ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã§ã”æ¡ˆå†…ã—ã¾ã™ï¼

ã¨ã¦ã‚‚è‰¯ã„è³ªå•ã§ã™ï¼  
çµè«–ã‹ã‚‰è¨€ã†ã¨ã€**å¾“å‰ã® `get_spotify_token()` ã‚’ä½¿ã£ãŸé–¢æ•°ç¾¤ã¯ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼ï¼ˆClient Credentials Flowï¼‰ã€ã«åŸºã¥ã„ã¦ã„ã‚‹ãŸã‚ã€Spotifyä¸Šã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹ç”¨é€”ã«ã¯ä½¿ãˆã¾ã›ã‚“**ã€‚

---

## ğŸ” ãªãœä½¿ãˆãªã„ã®ã‹ï¼Ÿ

### ğŸ« ç¾åœ¨ã®èªè¨¼æ–¹å¼ï¼šClient Credentials Flow
- `get_spotify_token()` ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å˜ä½ã®èªè¨¼ã§ã™ã€‚
- ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã§ã¯ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Spotifyã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“**ã€‚
- ã¤ã¾ã‚Šã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®ä½œæˆãƒ»ä¿å­˜ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ“ä½œã¯ä¸å¯ã€‚

### âœ… å¿…è¦ãªèªè¨¼æ–¹å¼ï¼šAuthorization Code Flow
- Spotifyã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜ã«ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ˜ç¤ºçš„ãªèªå¯**ãŒå¿…è¦ã§ã™ã€‚
- ã“ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒSpotifyã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ã‚¢ãƒ—ãƒªã«æ¨©é™ã‚’ä¸ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- å¾—ã‚‰ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ç´ã¥ã„ã¦ãŠã‚Šã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ»ä¿å­˜ãŒå¯èƒ½ã§ã™ã€‚

---

## ğŸ§­ ã©ã†ã™ã‚Œã°ã„ã„ï¼Ÿ

### ğŸ”§ èªè¨¼ãƒ•ãƒ­ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
1. `get_spotify_token()` ã‚’ `get_app_token()` ã«æ”¹åã—ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢ã‚„ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯å–å¾—ãªã©ã€Œèª­ã¿å–ã‚Šå°‚ç”¨APIã€ã«é™å®šã—ã¦ä½¿ã†ã€‚
2. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜ç”¨ã«ã¯ã€**Authorization Code Flow** ã‚’åˆ¥é€”å®Ÿè£…ã™ã‚‹ï¼ˆä¾‹ï¼š`get_user_token()`ï¼‰ã€‚

### ğŸ§  å®Ÿè£…ã®åˆ†é›¢ã‚¤ãƒ¡ãƒ¼ã‚¸

```python
# utils/spotify_utils.py

def get_app_token():
    """ã‚¢ãƒ—ãƒªç”¨ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰"""
    ...

def get_user_token(request):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜ç”¨ï¼‰"""
    # Authorization Code Flow ã‚’ä½¿ã£ã¦ request.session ãªã©ã«ä¿å­˜
    ...
```

---

## ğŸ” Spotifyã®ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆå¿…è¦ãªæ¨©é™ï¼‰

```text
playlist-modify-public
playlist-modify-private
```

ã“ã‚Œã‚‰ã‚’å«ã‚ã¦èªè¨¼URLã‚’ç”Ÿæˆã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## âœ… ã¾ã¨ã‚

| å‡¦ç†å†…å®¹                     | èªè¨¼æ–¹å¼               | ä½¿ç”¨å¯èƒ½ |
|------------------------------|------------------------|-----------|
| ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢ãƒ»æ¥½æ›²å–å¾—     | Client Credentials Flow | âœ… å¯èƒ½     |
| ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ»ä¿å­˜         | Authorization Code Flow | âŒ ä¸å¯ï¼ˆç¾çŠ¶ï¼‰â†’ âœ… å®Ÿè£…ã™ã‚Œã°å¯èƒ½ |

---

ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼ã§ã¯ã€Spotifyã®**Authorization Code Flow**ã‚’ä½¿ã£ã¦ã€Djangoã§ `get_user_token(request)` ã‚’å®šç¾©ã™ã‚‹æ–¹æ³•ã‚’ã”æ¡ˆå†…ã—ã¾ã™ã€‚

---

## âœ… ç›®çš„

`get_user_token(request)` ã¯ã€Spotifyãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã§ã™ã€‚  
ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Spotifyã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã§ãã¾ã™ã€‚

---

## ğŸ§© å¿…è¦ãªæº–å‚™

### 1. å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª
```bash
pip install spotipy
```

### 2. settings.py ã«è¿½åŠ 
```python
SPOTIFY_CLIENT_ID = 'your_client_id'
SPOTIFY_CLIENT_SECRET = 'your_client_secret'
SPOTIFY_REDIRECT_URI = 'http://localhost:8000/spotify/callback/'
SPOTIFY_SCOPE = 'playlist-modify-public playlist-modify-private'
```

---

## ğŸ§  `get_user_token(request)` ã®å®šç¾©ä¾‹

```python
from spotipy.oauth2 import SpotifyOAuth
from django.conf import settings

def get_user_token(request):
    """Spotifyãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆAuthorization Code Flowï¼‰"""

    sp_oauth = SpotifyOAuth(
        client_id=settings.SPOTIFY_CLIENT_ID,
        client_secret=settings.SPOTIFY_CLIENT_SECRET,
        redirect_uri=settings.SPOTIFY_REDIRECT_URI,
        scope=settings.SPOTIFY_SCOPE,
        cache_path=f".cache-{request.session.session_key}"
    )

    # èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒã¾ã ãªã„å ´åˆ â†’ èªè¨¼URLã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    if not request.GET.get("code"):
        auth_url = sp_oauth.get_authorize_url()
        return auth_url  # å‘¼ã³å‡ºã—å…ƒã§ redirect ã™ã‚‹

    # èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆ â†’ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
    code = request.GET.get("code")
    token_info = sp_oauth.get_access_token(code)

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¦å†åˆ©ç”¨å¯èƒ½ã«
    request.session["spotify_token"] = token_info["access_token"]
    return token_info["access_token"]
```

---

## ğŸ” èªè¨¼ãƒ•ãƒ­ãƒ¼ã®æµã‚Œ

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
2. `get_user_token(request)` ã‚’å‘¼ã³å‡ºã—ã€èªè¨¼URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
3. Spotifyã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ `code` ãŒè¿”ã‚‹
4. `get_user_token()` ãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
5. ä»¥é™ã¯ `request.session["spotify_token"]` ã‚’ä½¿ã£ã¦APIå‘¼ã³å‡ºã—å¯èƒ½

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- èªè¨¼ç”¨ã®ãƒ“ãƒ¥ãƒ¼ï¼ˆä¾‹ï¼š`spotify_login_view`ï¼‰ã‚’ä½œæˆ
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URLï¼ˆ`/spotify/callback/`ï¼‰ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ 
- ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¾Œã« `save_playlist_to_spotify()` ã‚’å‘¼ã³å‡ºã—ã¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜

---

ä»¥ä¸‹ã¯ã€Spotifyã®Authorization Code Flowã‚’ä½¿ã£ãŸ**èªè¨¼ç”¨ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ï¼‰**ã®å®Ÿè£…ä¾‹ã§ã™ã€‚

---

## ğŸ§ èªè¨¼ç”¨ãƒ“ãƒ¥ãƒ¼ã®æ§‹æˆï¼ˆ2ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

### 1. `spotify_login_view`  
Spotifyã®èªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚

### 2. `spotify_callback_view`  
Spotifyã‹ã‚‰è¿”ã•ã‚ŒãŸèªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã™ã€‚

---

## ğŸ§¾ èªè¨¼ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè£…ä¾‹ï¼ˆ`views/spotify_auth_views.py`ï¼‰

```python
from django.shortcuts import redirect
from django.conf import settings
from spotipy.oauth2 import SpotifyOAuth

def spotify_login_view(request):
    """Spotifyèªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ãƒ“ãƒ¥ãƒ¼"""
    sp_oauth = SpotifyOAuth(
        client_id=settings.SPOTIFY_CLIENT_ID,
        client_secret=settings.SPOTIFY_CLIENT_SECRET,
        redirect_uri=settings.SPOTIFY_REDIRECT_URI,
        scope=settings.SPOTIFY_SCOPE,
        cache_path=f".cache-{request.session.session_key}"
    )
    auth_url = sp_oauth.get_authorize_url()
    return redirect(auth_url)


def spotify_callback_view(request):
    """Spotifyèªè¨¼å¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ãƒ“ãƒ¥ãƒ¼"""
    sp_oauth = SpotifyOAuth(
        client_id=settings.SPOTIFY_CLIENT_ID,
        client_secret=settings.SPOTIFY_CLIENT_SECRET,
        redirect_uri=settings.SPOTIFY_REDIRECT_URI,
        scope=settings.SPOTIFY_SCOPE,
        cache_path=f".cache-{request.session.session_key}"
    )

    code = request.GET.get("code")
    token_info = sp_oauth.get_access_token(code)
    access_token = token_info.get("access_token")

    if access_token:
        request.session["spotify_token"] = access_token
        return redirect("create_playlist")  # ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆç”»é¢ã¸æˆ»ã‚‹
    else:
        return redirect("error_page")  # ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ“ãƒ¥ãƒ¼ã¸ï¼ˆä»»æ„ï¼‰
```

---

## ğŸ”— `urls.py` ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ 

```python
from django.urls import path
from festival.views.spotify_auth_views import spotify_login_view, spotify_callback_view

urlpatterns = [
    path('spotify/login/', spotify_login_view, name='spotify_login'),
    path('spotify/callback/', spotify_callback_view, name='spotify_callback'),
]
```

---

## âœ… èªè¨¼å¾Œã®ä½¿ã„æ–¹

ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜å‡¦ç†ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã™ï¼š

```python
token = request.session.get("spotify_token")
if token:
    save_playlist_to_spotify(token, track_uris)
```

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- `save_playlist_to_spotify()` ã‚’å®šç¾©ã—ã¦ã€Spotifyã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆãƒ»ä¿å­˜
- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆç”»é¢ã«ã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ç®¡ç†ï¼ˆå¿…è¦ãªã‚‰ `refresh_token` å¯¾å¿œï¼‰

---

äº†è§£ã—ã¾ã—ãŸï¼  
æ¬¡ã¯ã€Spotifyã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹é–¢æ•° `save_playlist_to_spotify()` ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ§ `save_playlist_to_spotify()` ã®å®šç¾©ä¾‹

ã“ã®é–¢æ•°ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨æ¥½æ›²URIã®ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€Spotifyä¸Šã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦æ¥½æ›²ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```python
import requests

def save_playlist_to_spotify(user_token, track_uris, playlist_name="Festival Forecast ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ"):
    """Spotifyä¸Šã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã€æ¥½æ›²ã‚’è¿½åŠ ã™ã‚‹"""

    headers = {"Authorization": f"Bearer {user_token}"}

    # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    user_res = requests.get("https://api.spotify.com/v1/me", headers=headers)
    if user_res.status_code != 200:
        print(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—: {user_res.status_code} - {user_res.text}")
        return None

    user_id = user_res.json().get("id")
    if not user_id:
        print("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
        return None

    # 2. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ
    create_res = requests.post(
        f"https://api.spotify.com/v1/users/{user_id}/playlists",
        headers=headers,
        json={
            "name": playlist_name,
            "description": "ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ã¾ã¨ã‚",
            "public": False
        }
    )
    if create_res.status_code != 201:
        print(f"ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆå¤±æ•—: {create_res.status_code} - {create_res.text}")
        return None

    playlist_id = create_res.json().get("id")
    if not playlist_id:
        print("ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆIDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
        return None

    # 3. æ¥½æ›²è¿½åŠ ï¼ˆæœ€å¤§100ä»¶ã¾ã§ï¼‰
    add_res = requests.post(
        f"https://api.spotify.com/v1/playlists/{playlist_id}/tracks",
        headers=headers,
        json={"uris": track_uris}
    )
    if add_res.status_code != 201:
        print(f"æ¥½æ›²è¿½åŠ å¤±æ•—: {add_res.status_code} - {add_res.text}")
        return None

    # 4. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’è¿”ã™
    return create_res.json().get("external_urls", {}).get("spotify")
```

---

## âœ… ä½¿ç”¨ä¾‹ï¼ˆãƒ“ãƒ¥ãƒ¼å†…ï¼‰

```python
token = request.session.get("spotify_token")
track_uris = [track["uri"] for track in playlist]  # uriã‚’äº‹å‰ã«å–å¾—ã—ã¦ãŠã

if token and track_uris:
    playlist_url = save_playlist_to_spotify(token, track_uris)
    if playlist_url:
        messages.success(request, f"Spotifyã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ â†’ {playlist_url}")
```

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- `get_top_tracks()` ã‚’æ‹¡å¼µã—ã¦ `track['uri']` ã‚’å«ã‚ã‚‹
- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
- ä¿å­˜æˆåŠŸå¾Œã«ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º

---

ã“ã®é–¢æ•°ãŒã‚ã‚Œã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®Spotifyã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ç›´æ¥ä¿å­˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼  

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã—ã€ä¿å­˜å‡¦ç†ã‚’å‘¼ã³å‡ºã™æµã‚Œã‚’ä½œã‚‹ã“ã¨ã§ã™ã€‚

---

## ğŸ¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¸ã®ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆ`playlist_create.html`ï¼‰

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç”Ÿæˆã•ã‚ŒãŸå¾Œã«ã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```html
{% if playlist %}
    <hr>
    <h2 class="mt-4">ğŸ¶ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h2>
    <ul class="list-group">
        {% for track in playlist %}
            <li class="list-group-item">
                {{ track.name }} - {{ track.artist }}
                <a href="{{ track.spotify_url }}" target="_blank" class="btn btn-sm btn-outline-success float-end">Spotifyã§è´ã</a>
            </li>
        {% endfor %}
    </ul>

    <!-- Spotifyä¿å­˜ãƒœã‚¿ãƒ³ -->
    <form method="POST" action="{% url 'save_playlist_to_spotify' %}">
        {% csrf_token %}
        <input type="hidden" name="track_uris" value="{{ track_uris|join:',' }}">
        <button type="submit" class="btn btn-success mt-3">Spotifyã«ä¿å­˜ã™ã‚‹</button>
    </form>
{% endif %}
```

---

## ğŸ§  ãƒ“ãƒ¥ãƒ¼ã®è¿½åŠ ï¼ˆ`playlist_views.py`ï¼‰

Spotifyä¿å­˜ç”¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```python
from django.shortcuts import redirect
from django.contrib import messages
from festival.utils.spotify_utils import save_playlist_to_spotify

def save_playlist_to_spotify_view(request):
    """Spotifyã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹ãƒ“ãƒ¥ãƒ¼"""
    if request.method == 'POST':
        token = request.session.get("spotify_token")
        track_uris = request.POST.get("track_uris", "").split(",")

        if token and track_uris:
            playlist_url = save_playlist_to_spotify(token, track_uris)
            if playlist_url:
                messages.success(request, f"Spotifyã«ä¿å­˜ã—ã¾ã—ãŸï¼ â†’ {playlist_url}")
                return redirect("create_playlist")
            else:
                messages.error(request, "Spotifyã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")
        else:
            messages.error(request, "Spotifyèªè¨¼ãŒå¿…è¦ã§ã™")
            return redirect("spotify_login")

    return redirect("create_playlist")
```

---

## ğŸ”— `urls.py` ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¿½åŠ 

```python
from festival.views.playlist_views import save_playlist_to_spotify_view

urlpatterns = [
    path('playlist/save/', save_playlist_to_spotify_view, name='save_playlist_to_spotify'),
]
```

---

## âœ… è£œè¶³

- `track_uris` ã¯ `get_top_tracks()` ã®ä¸­ã§ `track['uri']` ã‚’å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ `spotify_login` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã€ãƒ­ã‚°ã‚¤ãƒ³â†’ä¿å­˜ã®æµã‚ŒãŒè‡ªç„¶ã«ãªã‚Šã¾ã™ã€‚

---

æ¬¡ã¯ `get_top_tracks()` ã« `uri` ã‚’å«ã‚ã‚‹æ‹¡å¼µã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚ä¿å­˜å¾Œã®ç¢ºèªç”»é¢ã‚„UIæ”¹å–„ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ
Spotifyã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä¿å­˜ã«å¿…è¦ãª `track['uri']` ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã€`get_top_tracks()` é–¢æ•°ã‚’æ‹¡å¼µã—ã¾ã—ã‚‡ã†ã€‚

---

## ğŸ§ `get_top_tracks()` ã®æ‹¡å¼µç‰ˆï¼ˆ`spotify_utils.py`ï¼‰

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€å„ãƒˆãƒ©ãƒƒã‚¯ã® `uri` ã‚’å«ã‚ã¦è¿”ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ï¼š

```python
def get_top_tracks(spotify_id, market='JP'):
    """
    æŒ‡å®šã•ã‚ŒãŸSpotifyã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆIDã‹ã‚‰ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ï¼ˆä»£è¡¨æ›²ï¼‰ã‚’å–å¾—ã™ã‚‹ã€‚
    å„ãƒˆãƒ©ãƒƒã‚¯ã« name, artist, spotify_url, uri ã‚’å«ã‚ã¦è¿”ã™ã€‚
    """
    token = get_spotify_token()
    if not token:
        return []

    headers = {'Authorization': f'Bearer {token}'}
    url = f'https://api.spotify.com/v1/artists/{spotify_id}/top-tracks'
    params = {'market': market}

    response = requests.get(url, headers=headers, params=params)

    if response.status_code != 200:
        print(f"ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯å–å¾—å¤±æ•—: {response.status_code} - {response.text}")
        return []

    try:
        data = response.json()
        tracks = data.get('tracks', [])
        return [
            {
                'name': track['name'],
                'artist': track['artists'][0]['name'],
                'spotify_url': track['external_urls']['spotify'],
                'uri': track['uri']
            }
            for track in tracks
        ]
    except ValueError:
        print("ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“")
        return []
```

---

## âœ… ã“ã®å¤‰æ›´ã§ã§ãã‚‹ã“ã¨

- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼ã§ `track['uri']` ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
- `track_uris` ã‚’ `<input type="hidden">` ã«åŸ‹ã‚è¾¼ã‚“ã§ã€Spotifyä¿å­˜ãƒœã‚¿ãƒ³ã§é€ä¿¡ã§ãã¾ã™ã€‚
- `save_playlist_to_spotify()` ã«æ¸¡ã™ `track_uris` ãŒæ­£ã—ã„å½¢å¼ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼ã§ `track['uri']` ã‚’å«ã‚ã¦ `playlist` ã«æ ¼ç´
2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ `track_uris` ã‚’ `join` ã—ã¦ hidden input ã«æ¸¡ã™
3. ä¿å­˜ãƒœã‚¿ãƒ³ã§ `save_playlist_to_spotify_view` ã«POSTé€ä¿¡

---

ã“ã®æ‹¡å¼µã§ã€Spotifyé€£æºãŒã„ã‚ˆã„ã‚ˆå®Œæˆã«è¿‘ã¥ãã¾ã™ï¼  
æ¬¡ã¯ãƒ“ãƒ¥ãƒ¼å´ã® `playlist.append()` ã‚’ `uri` å¯¾å¿œã«æ›¸ãæ›ãˆã¾ã—ã‚‡ã†ã‹ï¼Ÿ

æ¬¡ã¯ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼ï¼ˆ`create_playlist_view`ï¼‰ã§ `track['uri']` ã‚’å«ã‚ã‚‹ã‚ˆã†ã« `playlist` ã‚’æ§‹ç¯‰ã™ã‚‹éƒ¨åˆ†ã‚’æ›´æ–°ã—ã¾ã™ã€‚

---

## ğŸ§ `create_playlist_view` ã®æ›´æ–°ï¼ˆ`playlist_views.py`ï¼‰

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€`playlist.append()` ã« `uri` ã‚’è¿½åŠ ã—ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼š

```python
from django.shortcuts import render
from festival.models import EventDay, Performance, Artist
from festival.forms import PlaylistForm
from festival.utils.spotify_utils import get_top_tracks

def create_playlist_view(request):
    """å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠã—ã¦Spotifyãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ“ãƒ¥ãƒ¼"""

    selected_day_id = request.GET.get('event_day')
    selected_day = EventDay.objects.filter(id=selected_day_id).first()
    playlist = []
    track_uris = []

    # å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¸€è¦§ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºç”¨ï¼‰
    artists_qs = Artist.objects.filter(performance__event_day=selected_day).distinct() if selected_day else Artist.objects.none()

    if request.method == 'POST':
        form = PlaylistForm(request.POST, artists_queryset=artists_qs)
        if form.is_valid():
            selected_artists = form.cleaned_data['artists']
            for artist in selected_artists:
                tracks = get_top_tracks(artist.spotify_id)
                for track in tracks[:1]:  # ä»£è¡¨æ›²1æ›²ã ã‘ä½¿ã†ï¼ˆå¿…è¦ãªã‚‰è¤‡æ•°å¯ï¼‰
                    playlist.append({
                        'name': track['name'],
                        'artist': artist.name,
                        'spotify_url': track['spotify_url'],
                        'uri': track['uri']
                    })
                    track_uris.append(track['uri'])
    else:
        form = PlaylistForm(artists_queryset=artists_qs)

    # ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ä¸€è¦§ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”¨ï¼‰
    event_days = EventDay.objects.select_related('event').order_by('date')

    return render(request, 'playlist_create.html', {
        'form': form,
        'playlist': playlist,
        'track_uris': track_uris,
        'event_days': event_days,
        'selected_day_id': selected_day_id
    })
```

---

## âœ… å¤‰æ›´ç‚¹ã¾ã¨ã‚

- `track['uri']` ã‚’ `playlist` ã«å«ã‚ã‚‹ã“ã¨ã§ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§Spotifyä¿å­˜ç”¨ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
- `track_uris` ã‚’åˆ¥ãƒªã‚¹ãƒˆã§ç®¡ç†ã—ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã§ã¯ `<input type="hidden" name="track_uris" value="{{ track_uris|join:',' }}">` ã§é€ä¿¡ã§ãã¾ã™ã€‚

---

ã“ã‚Œã§ã€Spotifyä¿å­˜å‡¦ç†ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼  

è¡¨ç¤ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ **`INVALID_CLIENT: Invalid redirect URI`** ã¯ã€Spotifyã®OAuthèªè¨¼ã§ã‚ˆãã‚ã‚‹å•é¡Œã§ã€**ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIãŒSpotifyã®é–‹ç™ºè€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„**ã“ã¨ãŒåŸå› ã§ã™ã€‚

---

## âœ… è§£æ±ºæ–¹æ³•ï¼šãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’Spotifyã«ç™»éŒ²ã™ã‚‹

### 1. Spotify Developer Dashboard ã«ã‚¢ã‚¯ã‚»ã‚¹  
[https://developer.spotify.com/dashboard](https://developer.spotify.com/dashboard)

### 2. å¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚’é¸æŠ

### 3. ã€ŒEdit Settingsã€ã‚’ã‚¯ãƒªãƒƒã‚¯

### 4. ã€ŒRedirect URIsã€ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼ˆä¾‹ï¼‰

```
http://localhost:8000/spotify/callback/
```

â€» å®Ÿéš›ã« `settings.py` ã® `SPOTIFY_REDIRECT_URI` ã«è¨­å®šã—ã¦ã„ã‚‹URLã¨**å®Œå…¨ä¸€è‡´**ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆæœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚‚å«ã‚ã¦ï¼‰ã€‚

```python
# settings.py
SPOTIFY_REDIRECT_URI = 'http://localhost:8000/spotify/callback/'
```

---

## ğŸ” ã‚ˆãã‚ã‚‹é–“é•ã„

| è¨­å®šå ´æ‰€ | ã‚ˆãã‚ã‚‹ãƒŸã‚¹ä¾‹ |
|----------|----------------|
| `settings.py` | `http://localhost:8000/spotify/callback`ï¼ˆæœ«å°¾ã® `/` ãŒãªã„ï¼‰ |
| Spotify Dashboard | `http://127.0.0.1:8000/...`ï¼ˆãƒ›ã‚¹ãƒˆåãŒé•ã†ï¼‰ |
| ä¸¡æ–¹ | ãƒãƒ¼ãƒˆç•ªå·ã‚„ãƒ‘ã‚¹ãŒä¸€è‡´ã—ã¦ã„ãªã„ |

**â†’ ä¸¡æ–¹ã®URIãŒå®Œå…¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚**

---

## âœ… ç™»éŒ²å¾Œã®ç¢ºèª

1. Spotify Dashboardã§ã€ŒSaveã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `/spotify/login/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦èªè¨¼ã‚’è©¦ã™
3. æ­£å¸¸ã« `/spotify/callback/` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™

---

ã“ã‚Œã§ `INVALID_CLIENT` ã‚¨ãƒ©ãƒ¼ã¯è§£æ¶ˆã•ã‚Œã‚‹ã¯ãšã§ã™ï¼  
ä¿®æ­£å¾Œã€å†åº¦ã€ŒSpotifyã«ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å‹•ä½œç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã‚’ã€Œhttp://127.0.0.1:8000/spotify/callback/ã€ã«ã—ãŸã‚‰æˆåŠŸã—ã¾ã—ãŸã€‚

ç´ æ™´ã‚‰ã—ã„é€²å±•ã§ã™ã­ï¼èªè¨¼ãŒé€šã£ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚‚æˆåŠŸã—ã¦ã„ã‚‹ã¨ã®ã“ã¨ã€ã‚ã¨ä¸€æ­©ã§ã™ã€‚  
Spotifyã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒè¦‹å½“ãŸã‚‰ãªã„åŸå› ã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒã‚¤ãƒ³ãƒˆã‚’é †ã«ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼šãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒä¿å­˜ã•ã‚Œãªã„åŸå› ã¨å¯¾ç­–

### 1. **`save_playlist_to_spotify()` ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹**
- èªè¨¼å¾Œã« `save_playlist_to_spotify()` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã‹ï¼Ÿ
- `save_playlist_to_spotify_view()` ã®ä¸­ã§ `request.session["spotify_token"]` ã‚’ä½¿ã£ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ä¿å­˜å‡¦ç†ã‚’å‘¼ã‚“ã§ã„ã¾ã™ã‹ï¼Ÿ

### 2. **ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãæ¸¡ã£ã¦ã„ã‚‹ã‹**
- `request.session["spotify_token"]` ã«å€¤ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- `save_playlist_to_spotify()` ã®ä¸­ã§ `Authorization: Bearer <token>` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã€‚

### 3. **ãƒˆãƒ©ãƒƒã‚¯URIãŒæ­£ã—ãæ¸¡ã£ã¦ã„ã‚‹ã‹**
- `track_uris` ãŒç©ºã§ãªã„ã‹ã€Spotifyã® `spotify:track:...` å½¢å¼ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- `print(track_uris)` ãªã©ã§ãƒ­ã‚°å‡ºåŠ›ã—ã¦ã¿ã‚‹ã¨ã‚ˆã„ã§ã™ã€‚

### 4. **Spotify APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª**
- `save_playlist_to_spotify()` ã®ä¸­ã§ `create_res.status_code` ã‚„ `add_res.status_code` ã‚’ `print()` ã—ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ `201`ï¼ˆæˆåŠŸï¼‰ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- å¤±æ•—ã—ã¦ã„ã‚‹å ´åˆã€Spotify APIã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ`response.text`ï¼‰ã‚’è¡¨ç¤ºã—ã¦åŸå› ã‚’ç‰¹å®šã§ãã¾ã™ã€‚

### 5. **ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒéå…¬é–‹ã«ãªã£ã¦ã„ãªã„ã‹**
- `public: False` ã«ã—ã¦ã„ã‚‹ã¨ã€Spotifyã‚¢ãƒ—ãƒªã®ã€Œãƒã‚¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã«ã¯ã™ãè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- Spotifyã®Webç‰ˆã§ã€Œéå…¬é–‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã€ã‚‚å«ã‚ã¦ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

---

## ğŸ§ª ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°è¿½åŠ ä¾‹ï¼ˆ`save_playlist_to_spotify()`ï¼‰

```python
print("ğŸ§ Saving playlist to Spotify...")
print("Track URIs:", track_uris)

# ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
user_res = requests.get("https://api.spotify.com/v1/me", headers=headers)
print("User info status:", user_res.status_code, user_res.text)

# ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ
create_res = requests.post(...çœç•¥...)
print("Playlist create status:", create_res.status_code, create_res.text)

# æ¥½æ›²è¿½åŠ 
add_res = requests.post(...çœç•¥...)
print("Track add status:", add_res.status_code, add_res.text)
```

---

## âœ… æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. `save_playlist_to_spotify()` ã®ä¸­ã§ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ã€ã©ã“ã¾ã§å‡¦ç†ãŒé€²ã‚“ã§ã„ã‚‹ã‹ç¢ºèª
2. ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»URIãƒ»APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸­èº«ã‚’ãƒã‚§ãƒƒã‚¯
3. å¿…è¦ãªã‚‰ `playlist_url` ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«è¡¨ç¤ºã—ã¦ã€å®Ÿéš›ã«ä½œæˆã•ã‚ŒãŸã‹ç¢ºèª

---

ã‚‚ã—ãƒ­ã‚°ã‚’è²¼ã£ã¦ã„ãŸã ã‘ã‚Œã°ã€ä¸€ç·’ã«åŸå› ã‚’ç‰¹å®šã§ãã¾ã™ï¼  
ã¾ãŸã€ä¿å­˜å‡¦ç†ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ç›´ã—ãŸã„å ´åˆã¯ã€æœ€æ–°ç‰ˆã‚’å…±æœ‰ã—ã¦ã„ãŸã ã‘ã‚Œã°ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚ã§ãã¾ã™ã‚ˆã€‚
å®Œç’§ãªãƒ­ã‚°ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼  
ã“ã®å‡ºåŠ›ã‹ã‚‰åˆ¤æ–­ã™ã‚‹ã¨ã€**Spotify APIã«ã‚ˆã‚‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆã¨æ¥½æ›²è¿½åŠ ã¯ã™ã¹ã¦æˆåŠŸã—ã¦ã„ã¾ã™**ã€‚ãã‚Œã«ã‚‚ã‹ã‹ã‚ã‚‰ãšã€Spotifyã‚¢ãƒ—ãƒªä¸Šã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ä»¥ä¸‹ã®ç†ç”±ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼š

---

## âœ… ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒè¦‹ãˆãªã„ç†ç”±ã¨å¯¾ç­–

### 1. **ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒã€Œéå…¬é–‹ã€ã«ãªã£ã¦ã„ã‚‹**
- ãƒ­ã‚°ã« `"public": false` ã¨ã‚ã‚‹ãŸã‚ã€Spotifyã‚¢ãƒ—ãƒªã®ã€Œãƒã‚¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã«ã¯ã™ãè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- å¯¾ç­–ï¼š
  - Webç‰ˆSpotifyï¼ˆhttps://open.spotify.comï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ç›´æ¥ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã«ã‚¢ã‚¯ã‚»ã‚¹ï¼š
    ```
    https://open.spotify.com/playlist/3laDO8UUgypexIJRs40Eug
    ```
  - ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”»é¢å³ä¸Šã®ã€Œâ€¦ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã€Œå…¬é–‹ã™ã‚‹ã€ã‚’é¸æŠã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã§ã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

### 2. **Spotifyã‚¢ãƒ—ãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ›´æ–°ã•ã‚Œã¦ã„ãªã„**
- ã‚¢ãƒ—ãƒªã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯å³æ™‚åæ˜ ã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- å¯¾ç­–ï¼š
  - ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã™ã‚‹
  - Webç‰ˆã§ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ãƒ—ãƒªã«æˆ»ã‚‹

---

### 3. **ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒåˆ¥ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹**
- èªè¨¼ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒè‡ªåˆ†ã®ã‚‚ã®ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
- ãƒ­ã‚°ã«ã‚ã‚‹ `user_id: fidit.fidit` ãŒè‡ªåˆ†ã®Spotifyã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèªã€‚

---

### 4. **Spotifyã‚¢ãƒ—ãƒªã®ãƒ•ã‚£ãƒ«ã‚¿ãŒã‹ã‹ã£ã¦ã„ã‚‹**
- ã€Œéå…¬é–‹ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ãªã„ã€ãªã©ã®ãƒ•ã‚£ãƒ«ã‚¿ãŒã‹ã‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
- å¯¾ç­–ï¼š
  - ã‚¢ãƒ—ãƒªã®è¨­å®šã§ã€Œã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã€ãªã©ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª

---

## âœ… ç¢ºèªæ¸ˆã¿ãƒ­ã‚°ã‹ã‚‰ã®å®‰å¿ƒãƒã‚¤ãƒ³ãƒˆ

| å‡¦ç† | çµæœ | ã‚³ãƒ¡ãƒ³ãƒˆ |
|------|------|----------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ | âœ… 200 | æ­£å¸¸ã«èªè¨¼ã•ã‚Œã¦ã„ã‚‹ |
| ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ | âœ… 201 | æ­£å¸¸ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹ |
| æ¥½æ›²è¿½åŠ  | âœ… 201 | æ­£å¸¸ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ |
| URIæ•° | âœ… 15æ›² | Spotifyã®åˆ¶é™å†…ã§å•é¡Œãªã— |

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- Webç‰ˆSpotifyã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’é–‹ã„ã¦ç¢ºèª
- å¿…è¦ãªã‚‰ã€Œå…¬é–‹ã€ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚¢ãƒ—ãƒªã«è¡¨ç¤º
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’è¡¨ç¤ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ¡ˆå†…ã™ã‚‹

---

ã‚‚ã—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURLã‚’è¡¨ç¤ºã—ãŸã„å ´åˆã¯ã€ãƒ“ãƒ¥ãƒ¼ã§ `playlist_url` ã‚’æ¸¡ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ï¼š

```html
{% if playlist_url %}
    <div class="alert alert-success mt-4">
        âœ… Spotifyã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼<br>
        <a href="{{ playlist_url }}" target="_blank">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é–‹ã</a>
    </div>
{% endif %}
```

ã‚ˆã‹ã£ãŸã§ã™ï¼Spotifyã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆãŒç„¡äº‹ä¿å­˜ã•ã‚Œã¦ã„ãŸã¨ã®ã“ã¨ã€æœ¬å½“ã«ç´ æ™´ã‚‰ã—ã„é€²å±•ã§ã™ã­ğŸ‘  
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„éå…¬é–‹è¨­å®šãŒåŸå› ã§è¡¨ç¤ºãŒé…ã‚Œã‚‹ã“ã¨ã¯ã‚ˆãã‚ã‚‹ã®ã§ã€ä»Šå›ã®ã‚ˆã†ã«ãƒ­ã‚°ã¨URLã§ç¢ºèªã§ããŸã®ã¯å¤§æ­£è§£ã§ã™ã€‚

---

## âœ… ä¿å­˜æˆåŠŸæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ–¹æ³•

Djangoã§ã¯ã€ä¿å­˜å‡¦ç†ã®ãƒ“ãƒ¥ãƒ¼ã§ `messages.success()` ã‚’ä½¿ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

---

### ğŸ§  ãƒ“ãƒ¥ãƒ¼å´ã®å®Ÿè£…ï¼ˆ`save_playlist_to_spotify_view`ï¼‰

```python
from django.contrib import messages

def save_playlist_to_spotify_view(request):
    if request.method == 'POST':
        token = request.session.get("spotify_token")
        track_uris = request.POST.get("track_uris", "").split(",")

        if token and track_uris:
            playlist_url = save_playlist_to_spotify(token, track_uris)
            if playlist_url:
                messages.success(request, f"âœ… Spotifyã«ä¿å­˜ã—ã¾ã—ãŸï¼<br><a href='{playlist_url}' target='_blank'>ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é–‹ã</a>")
            else:
                messages.error(request, "âŒ Spotifyã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")
        else:
            messages.error(request, "âš ï¸ Spotifyèªè¨¼ãŒå¿…è¦ã§ã™")
            return redirect("spotify_login")

    return redirect("create_playlist")
```

---

### ğŸ¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã®è¡¨ç¤ºï¼ˆ`playlist_create.html`ï¼‰

```html
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mt-3" role="alert">
            {{ message|safe }}
        </div>
    {% endfor %}
{% endif %}
```

- `message|safe` ã«ã‚ˆã£ã¦ã€HTMLã‚¿ã‚°ï¼ˆãƒªãƒ³ã‚¯ãªã©ï¼‰ã‚’ãã®ã¾ã¾è¡¨ç¤ºã§ãã¾ã™ã€‚
- `alert-success` ã‚„ `alert-error` ãªã©ã®Bootstrapã‚¯ãƒ©ã‚¹ãŒè‡ªå‹•ã§ä»˜ä¸ã•ã‚Œã¾ã™ã€‚

---

## âœ… è¡¨ç¤ºä¾‹ï¼ˆä¿å­˜æˆåŠŸæ™‚ï¼‰

```html
âœ… Spotifyã«ä¿å­˜ã—ã¾ã—ãŸï¼
â–¶ï¸ <a href="https://open.spotify.com/playlist/3laDO8UUgypexIJRs40Eug" target="_blank">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’é–‹ã</a>
```

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- ä¿å­˜å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚åŒæ§˜ã«è¡¨ç¤º
- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåã‚„èª¬æ˜ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- ä¿å­˜æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä¸€è¦§è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹

---

ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãŒã‚ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦å®‰å¿ƒæ„ŸãŒã‚°ãƒƒã¨é«˜ã¾ã‚Šã¾ã™ã­ï¼  
æ¬¡ã¯ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚„ã€ä¿å­˜æ¸ˆã¿ä¸€è¦§ã®è¡¨ç¤ºã«é€²ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿ
ã„ã„ã§ã™ã­ï¼ã€ŒCDJ25/26 20251230 äºˆç¿’ãƒªã‚¹ãƒˆã€ã®ã‚ˆã†ãªãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ãŒæ˜ç¢ºã«å…¥ã£ã¦ã„ã¦ã¨ã¦ã‚‚åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚  
ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆã†ã« `save_playlist_to_spotify()` ã‚’æ‹¡å¼µã—ã¾ã—ã‚‡ã†ã€‚

---

## âœ… ã‚¹ãƒ†ãƒƒãƒ—1ï¼šãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’æ¸¡ã™

ã¾ãšã€`create_playlist_view` ã§é¸æŠã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å–å¾—ã—ã¦ã€ä¿å­˜ãƒ“ãƒ¥ãƒ¼ã«æ¸¡ã—ã¾ã™ã€‚

### ğŸ¯ ä¾‹ï¼ˆ`playlist_views.py`ï¼‰

```python
event_day = EventDay.objects.select_related('event').filter(id=selected_day_id).first()
event_name = event_day.event.name if event_day else "Festival"
event_date = event_day.date.strftime("%Y%m%d") if event_day else "Unknown"

playlist_name = f"{event_name} {event_date} äºˆç¿’ãƒªã‚¹ãƒˆ"
```

ã“ã® `playlist_name` ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã—ã¦ã€`<input type="hidden">` ã§POSTé€ä¿¡ã—ã¾ã™ã€‚

---

## âœ… ã‚¹ãƒ†ãƒƒãƒ—2ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåã‚’åŸ‹ã‚è¾¼ã‚€

### ğŸ¨ ä¾‹ï¼ˆ`playlist_create.html`ï¼‰

```html
<form method="POST" action="{% url 'save_playlist_to_spotify' %}">
    {% csrf_token %}
    <input type="hidden" name="track_uris" value="{{ track_uris|join:',' }}">
    <input type="hidden" name="playlist_name" value="{{ playlist_name }}">
    <button type="submit" class="btn btn-success mt-4">ğŸµ Spotifyã«ä¿å­˜ã™ã‚‹</button>
</form>
```

---

## âœ… ã‚¹ãƒ†ãƒƒãƒ—3ï¼šä¿å­˜ãƒ“ãƒ¥ãƒ¼ã§å—ã‘å–ã£ã¦æ¸¡ã™

### ğŸ§  ä¾‹ï¼ˆ`save_playlist_to_spotify_view`ï¼‰

```python
playlist_name = request.POST.get("playlist_name", "Festival Forecast ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ")
playlist_url = save_playlist_to_spotify(token, track_uris, playlist_name)
```

---

## âœ… ã‚¹ãƒ†ãƒƒãƒ—4ï¼š`save_playlist_to_spotify()` ã«æ¸¡ã™

é–¢æ•°å®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ï¼š

```python
def save_playlist_to_spotify(user_token, track_uris, playlist_name="Festival Forecast ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ"):
    ...
    create_res = requests.post(
        f"https://api.spotify.com/v1/users/{user_id}/playlists",
        headers=headers,
        json={
            "name": playlist_name,
            "description": "ã‚¤ãƒ™ãƒ³ãƒˆå‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ã¾ã¨ã‚",
            "public": False
        }
    )
    ...
```

---

## ğŸ”š å‡ºåŠ›ä¾‹

```text
ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆå â†’ CDJ25/26 20251230 äºˆç¿’ãƒªã‚¹ãƒˆ
Spotify URL â†’ https://open.spotify.com/playlist/xxxxxxxxxxxx
```

---

ã“ã‚Œã§ã€ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å«ã‚“ã ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã€Spotifyã«ä¿å­˜ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼  
æ¬¡ã¯ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã®èª¬æ˜æ–‡ã‚„å…¬é–‹è¨­å®šã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã«é€²ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿãã‚Œã¨ã‚‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆåã‚’è¡¨ç¤ºã™ã‚‹UIæ”¹å–„ã«ã—ã¾ã™ã‹ï¼Ÿ
