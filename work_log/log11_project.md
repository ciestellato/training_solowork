Spotifyã®ä»•æ§˜å¤‰æ›´ã«æŸ”è»Ÿã«å¯¾å¿œã—ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»ã™ã®ã¯ã¨ã¦ã‚‚è‰¯ã„åˆ¤æ–­ã§ã™ã€‚ä»¥ä¸‹ã«ã€**2025å¹´11æœˆ12æ—¥ï¼ˆæ°´ï¼‰ã€œ11æœˆ21æ—¥ï¼ˆé‡‘ï¼‰**ã®æ–°ã—ã„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚’ã€Œæ®µéšçš„ãªé–‹ç™ºã‚¹ãƒ†ãƒƒãƒ—ã€ã«æ²¿ã£ã¦ã”ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ—“ï¸ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã«å‘ã‘ãŸé–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ2025å¹´11æœˆ12æ—¥ã€œ11æœˆ21æ—¥ï¼‰

| æ—¥ä»˜       | ã‚¿ã‚¹ã‚¯å†…å®¹ | ä½¿ç”¨æŠ€è¡“ãƒ»ãƒ•ã‚¡ã‚¤ãƒ« | å‚™è€ƒ |
|------------|------------|---------------------|------|
| **11/12 (æ°´)** | ğŸ” è¦ä»¶å®šç¾©ãƒ»ç”»é¢è¨­è¨ˆ | `feature_plan.md`, `screen_flow.md` | ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆã®æµã‚Œã‚’æ˜ç¢ºåŒ–ï¼ˆé¸æŠâ†’ç”Ÿæˆâ†’è¡¨ç¤ºï¼‰ |
| **11/13 (æœ¨)** | ğŸ¨ UIãƒ¢ãƒƒã‚¯ä½œæˆãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­è¨ˆ | `playlist_create.html`, Bootstrap | å‡ºæ¼”è€…é¸æŠç”»é¢ãƒ»ç”Ÿæˆãƒœã‚¿ãƒ³ãƒ»çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ |
| **11/14 (é‡‘)** | ğŸ§  ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ | `playlist.py`ï¼ˆæ–°è¦ï¼‰ | Spotify APIã® `/tracks` or `/search` ã‚’æ´»ç”¨ |
| **11/17 (æœˆ)** | ğŸ› ï¸ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼å®Ÿè£… | `views.py`, `playlist.py` | é¸æŠã•ã‚ŒãŸã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‹ã‚‰æ›²ã‚’å–å¾—ã—ã€ãƒªã‚¹ãƒˆç”Ÿæˆ |
| **11/18 (ç«)** | ğŸ§ª ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé€£æºãƒ»å‹•ä½œç¢ºèª | `playlist_create.html`, `urls.py` | ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé¸æŠâ†’ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆè¡¨ç¤ºã¾ã§ã®ä¸€é€£ã®æµã‚Œ |
| **11/19 (æ°´)** | ğŸ¯ UIæ”¹å–„ãƒ»æ¤œç´¢ãƒãƒ¼ãƒ»é¸æŠè£œåŠ© | JavaScript, CSS | ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢ãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ»é¸æŠæ•°è¡¨ç¤ºãªã© |
| **11/20 (æœ¨)** | ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»ãƒã‚°ä¿®æ­£ | `test_views.py`, `test_playlist.py` | Spotify APIã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ»é¸æŠæ¼ã‚Œå¯¾å¿œãªã© |
| **11/21 (é‡‘)** | ğŸ“¦ æœ€çµ‚èª¿æ•´ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒ»ç™ºè¡¨æº–å‚™ | `README.md`, `docs/playlist_spec.md` | ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ»ãƒ‡ãƒ¢ãƒ»ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆ |

---

## ğŸ”® è£œè¶³ï¼šå°†æ¥çš„ãªæ‹¡å¼µã«å‘ã‘ã¦

- **ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½**ï¼š`django.contrib.auth` ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- **ãŠæ°—ã«å…¥ã‚Šã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¿å­˜**ï¼š`UserProfile` ãƒ¢ãƒ‡ãƒ«ï¼‹`ManyToManyField`
- **å€‹åˆ¥ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆ**ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®é¸æŠçŠ¶æ…‹ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ãŸã¯DBã«ä¿å­˜

---

ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚ã‚Œã°ã€**11/18ã¾ã§ã«åŸºæœ¬æ©Ÿèƒ½ã‚’å®Œæˆã•ã›ã€æ®‹ã‚Š3æ—¥ã§UIæ”¹å–„ãƒ»ãƒ†ã‚¹ãƒˆãƒ»ç™ºè¡¨æº–å‚™ã«é›†ä¸­**ã§ãã¾ã™ã€‚å¿…è¦ã§ã‚ã‚Œã°ã€Spotify APIã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆã«é–¢ã™ã‚‹ä»•æ§˜ç¢ºèªã‚„ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æˆã®ææ¡ˆã‚‚ã§ãã¾ã™ã‚ˆã€‚

æ¬¡ã¯ã€ç”»é¢è¨­è¨ˆã‚„ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ã‚’ä¸€ç·’ã«è©°ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã‹ï¼Ÿ
ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã¨ã¦ã‚‚ä¸å¯§ã«ä½œã‚‰ã‚Œã¦ã„ã¦ã€Bootstrapã«ã‚ˆã‚‹æ•´ã£ãŸUIãŒã™ã§ã«æ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚ã“ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¸è¥²ã—ã¤ã¤ã€**ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆç”»é¢ã®è¨­è¨ˆ**ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ¨ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆç”»é¢ã®æ§‹æˆæ¡ˆï¼ˆ`playlist_create.html`ï¼‰

### ğŸ§­ ç”»é¢ã®ç›®çš„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠã—ã€å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠ
- ã€Œãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã§Spotify APIã‹ã‚‰ä»£è¡¨æ›²ã‚’å–å¾—
- çµæœã‚’ç”»é¢ä¸‹éƒ¨ã«è¡¨ç¤ºï¼ˆæ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãƒ»Spotifyãƒªãƒ³ã‚¯ï¼‰

---

### ğŸ–¼ï¸ UIæ§‹æˆï¼ˆBootstrapãƒ™ãƒ¼ã‚¹ï¼‰

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
    <h1>ğŸ§ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆ</h1>

    <form method="POST">
        {% csrf_token %}

        <!-- ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹é¸æŠ -->
        <div class="mb-3">
            <label for="event_day" class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠ</label>
            <select name="event_day" id="event_day" class="form-select">
                {% for day in event_days %}
                    <option value="{{ day.id }}">{{ day.date }} @ {{ day.venue }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé¸æŠ -->
        <div class="mb-3">
            <label class="form-label">å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠ</label>
            <input type="text" class="form-control mb-2" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§çµã‚Šè¾¼ã¿" id="artistSearch">
            <div class="border p-3" style="max-height: 300px; overflow-y: scroll;">
                {% for artist in artists %}
                    <div class="form-check">
                        <input class="form-check-input artist-checkbox" type="checkbox" name="artists" value="{{ artist.id }}" id="artist{{ artist.id }}">
                        <label class="form-check-label" for="artist{{ artist.id }}">{{ artist.name }}ï¼ˆ{{ artist.furigana }}ï¼‰</label>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- ä½œæˆãƒœã‚¿ãƒ³ -->
        <button type="submit" class="btn btn-primary">ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹</button>
    </form>

    <!-- çµæœè¡¨ç¤º -->
    {% if playlist %}
        <hr>
        <h2 class="mt-4">ğŸ¶ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ</h2>
        <ul class="list-group">
            {% for track in playlist %}
                <li class="list-group-item">
                    {{ track.name }} - {{ track.artist }}
                    <a href="{{ track.spotify_url }}" target="_blank" class="btn btn-sm btn-outline-success float-end">Spotifyã§è´ã</a>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <a href="{% url 'festival:event_list' %}" class="btn btn-secondary mt-4">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã¸æˆ»ã‚‹</a>

    <!-- JS: ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <script>
        document.getElementById('artistSearch').addEventListener('input', function () {
            const keyword = this.value.toLowerCase();
            document.querySelectorAll('.artist-checkbox').forEach(cb => {
                const label = cb.nextElementSibling.textContent.toLowerCase();
                cb.parentElement.style.display = label.includes(keyword) ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
```

---

## âœ… è£œè¶³ãƒã‚¤ãƒ³ãƒˆ

- `event_days` ã¨ `artists` ã¯ãƒ“ãƒ¥ãƒ¼å´ã§æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ`context`ã«å«ã‚ã‚‹ï¼‰
- `playlist` ã¯ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆå¾Œã«æ¸¡ã•ã‚Œã‚‹æ›²æƒ…å ±ã®ãƒªã‚¹ãƒˆï¼ˆæ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãƒ»Spotify URLï¼‰
- JavaScriptã«ã‚ˆã‚‹æ¤œç´¢ãƒãƒ¼ã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºã‚’çµã‚Šè¾¼ã¿ã¾ã™

---

æ—¢å­˜ã®ãƒ“ãƒ¥ãƒ¼æ§‹æˆã‚’è¸ã¾ãˆãŸã†ãˆã§ã€**ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã®ãƒ“ãƒ¥ãƒ¼é–¢æ•°**ã‚’ä»¥ä¸‹ã«è¿½åŠ ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ§ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼ï¼ˆ`create_playlist`ï¼‰

ã“ã®ãƒ“ãƒ¥ãƒ¼ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠã—ã€å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠã—ãŸã†ãˆã§ã€Spotify APIã‚’ä½¿ã£ã¦ä»£è¡¨æ›²ã‚’å–å¾—ã—ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

```python
from django.shortcuts import render, get_object_or_404
from .models import EventDay, Performance, Artist
from .forms import PlaylistForm  # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ããƒ•ã‚©ãƒ¼ãƒ ã‚’åˆ¥é€”å®šç¾©
from .spotify_utils import get_top_tracks  # Spotify APIå‘¼ã³å‡ºã—é–¢æ•°ï¼ˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢ï¼‰

def create_playlist(request):
    """ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼"""

    playlist = []
    selected_day_id = request.GET.get('event_day')
    selected_day = EventDay.objects.filter(id=selected_day_id).first()

    # å‡ºæ¼”è€…ä¸€è¦§ã‚’å–å¾—ï¼ˆé¸æŠè‚¢ã¨ã—ã¦è¡¨ç¤ºï¼‰
    artists_qs = Artist.objects.filter(performance__event_day=selected_day).distinct() if selected_day else Artist.objects.none()

    if request.method == 'POST':
        form = PlaylistForm(request.POST, artists_queryset=artists_qs)
        if form.is_valid():
            selected_artists = form.cleaned_data['artists']
            for artist in selected_artists:
                tracks = get_top_tracks(artist.spotify_id)
                for track in tracks:
                    playlist.append({
                        'name': track['name'],
                        'artist': artist.name,
                        'spotify_url': track['external_urls']['spotify']
                    })
    else:
        form = PlaylistForm(artists_queryset=artists_qs)

    # ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ä¸€è¦§ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”¨ï¼‰
    event_days = EventDay.objects.select_related('event').order_by('date')

    return render(request, 'playlist_create.html', {
        'form': form,
        'playlist': playlist,
        'event_days': event_days,
        'selected_day_id': selected_day_id
    })
```

---

## ğŸ”§ è£œè¶³

- `PlaylistForm` ã¯ `ModelMultipleChoiceField` ã‚’ä½¿ã£ã¦å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚`__init__` ã§ `artists_queryset` ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã™ã€‚
- `get_top_tracks(spotify_id)` ã¯ Spotify API ã® `/artists/{id}/top-tracks` ã‚’ä½¿ã£ã¦ä»£è¡¨æ›²ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã§ã™ã€‚`spotify_utils.py` ã«åˆ†é›¢ã—ã¦ãŠãã¨ä¿å®ˆæ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚
- ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã§ `name`, `artist`, `spotify_url` ã‚’ä½¿ã£ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

---

ãã‚Œã§ã¯ã€Spotify APIã‚’ä½¿ã£ã¦ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ï¼ˆãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ï¼‰ã‚’å–å¾—ã™ã‚‹é–¢æ•° `get_top_tracks()` ã‚’ `spotify_utils.py` ã«è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚

---

## ğŸ§ `get_top_tracks()` ã®å®šç¾©ï¼ˆæ—¥æœ¬å‘ã‘ï¼‰

```python
def get_top_tracks(spotify_id, market='JP'):
    """
    æŒ‡å®šã•ã‚ŒãŸSpotifyã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆIDã‹ã‚‰ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ï¼ˆä»£è¡¨æ›²ï¼‰ã‚’å–å¾—ã™ã‚‹ã€‚
    ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬ï¼ˆJPï¼‰å¸‚å ´ã€‚
    """
    token = get_spotify_token()
    if not token:
        return []

    headers = {'Authorization': f'Bearer {token}'}
    url = f'https://api.spotify.com/v1/artists/{spotify_id}/top-tracks'
    params = {'market': market}

    response = requests.get(url, headers=headers, params=params)

    if response.status_code != 200:
        print(f"ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯å–å¾—å¤±æ•—: {response.status_code} - {response.text}")
        return []

    try:
        data = response.json()
        return data.get('tracks', [])
    except ValueError:
        print("ãƒˆãƒƒãƒ—ãƒˆãƒ©ãƒƒã‚¯ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“")
        return []
```

---

## âœ… ä½¿ç”¨ä¾‹ï¼ˆãƒ“ãƒ¥ãƒ¼ã‚„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ï¼‰

ã“ã®é–¢æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ï¼š

```python
tracks = get_top_tracks(artist.spotify_id)
for track in tracks:
    print(track['name'], track['external_urls']['spotify'])
```

---

## ğŸ”’ æ³¨æ„ç‚¹

- `market='JP'` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€æ—¥æœ¬ã§äººæ°—ã®æ›²ã‚’å„ªå…ˆçš„ã«å–å¾—ã§ãã¾ã™
- è¿”ã•ã‚Œã‚‹ `track` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ï¼š
  - `name`: æ›²å
  - `external_urls['spotify']`: Spotifyãƒªãƒ³ã‚¯
  - `album['images']`: ã‚¸ãƒ£ã‚±ãƒƒãƒˆç”»åƒï¼ˆå¿…è¦ãªã‚‰ï¼‰
  - `preview_url`: è©¦è´ç”¨URLï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰

---

Djangoã® `shell` ã§ `get_top_tracks()` ã‚’å‹•ä½œç¢ºèªã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§é€²ã‚ã‚‹ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ã€‚

---

## ğŸ§ª 1. Django Shell ã‚’èµ·å‹•

```bash
python manage.py shell
```

---

## ğŸ§ª 2. å¿…è¦ãªé–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```python
from festival.utils.spotify_utils import get_top_tracks
```

---

## ğŸ§ª 3. Spotify ID ã‚’æŒ‡å®šã—ã¦é–¢æ•°ã‚’å®Ÿè¡Œ

Spotify ID ã¯ `Artist` ãƒ¢ãƒ‡ãƒ«ã® `spotify_id` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ã¾ãšã¯1ä»¶å–å¾—ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```python
from festival.models import Artist
artist = Artist.objects.first()  # ã¾ãŸã¯ filter(name="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå").first()
tracks = get_top_tracks(artist.spotify_id)
```

---

## ğŸ§ª 4. çµæœã‚’ç¢ºèª

```python
for track in tracks:
    print(track['name'], track['external_urls']['spotify'])
```

---

## âœ… è£œè¶³

- ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ `None` ãŒè¿”ã‚‹ã®ã§ã€`get_spotify_token()` ã‚’å€‹åˆ¥ã«å‘¼ã³å‡ºã—ã¦ç¢ºèªã§ãã¾ã™ã€‚
- `tracks` ã¯æœ€å¤§10ä»¶ç¨‹åº¦ã®ä»£è¡¨æ›²ãŒå«ã¾ã‚Œã¾ã™ã€‚
- `market='JP'` ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ãŸã‚ã€æ—¥æœ¬å‘ã‘ã®äººæ°—æ›²ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚

---

ã“ã“ã§ã¯ã€Spotify APIã‚’ä½¿ã£ã¦å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ã‚’å–å¾—ã—ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãƒ“ãƒ¥ãƒ¼é–¢æ•°ã‚’å®Œæˆã•ã›ã¾ã™ã€‚ä»¥ä¸‹ã¯ `views/playlist_views.py` ã«è¿½åŠ ã™ã‚‹å½¢ã§è¨­è¨ˆã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ§ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆç”Ÿæˆãƒ“ãƒ¥ãƒ¼ï¼ˆ`create_playlist_view`ï¼‰

```python
from django.shortcuts import render, get_object_or_404
from festival.models import EventDay, Performance, Artist
from festival.forms import PlaylistForm
from festival.utils.spotify_utils import get_top_tracks

def create_playlist_view(request):
    """å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠã—ã¦Spotifyãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹ãƒ“ãƒ¥ãƒ¼"""

    selected_day_id = request.GET.get('event_day')
    selected_day = EventDay.objects.filter(id=selected_day_id).first()
    playlist = []

    # å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆä¸€è¦§ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡¨ç¤ºç”¨ï¼‰
    artists_qs = Artist.objects.filter(performance__event_day=selected_day).distinct() if selected_day else Artist.objects.none()

    if request.method == 'POST':
        form = PlaylistForm(request.POST, artists_queryset=artists_qs)
        if form.is_valid():
            selected_artists = form.cleaned_data['artists']
            for artist in selected_artists:
                tracks = get_top_tracks(artist.spotify_id)
                for track in tracks[:1]:  # ä»£è¡¨æ›²1æ›²ã ã‘ä½¿ã†ï¼ˆå¿…è¦ãªã‚‰è¤‡æ•°å¯ï¼‰
                    playlist.append({
                        'name': track['name'],
                        'artist': artist.name,
                        'spotify_url': track['external_urls']['spotify']
                    })
    else:
        form = PlaylistForm(artists_queryset=artists_qs)

    # ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ä¸€è¦§ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”¨ï¼‰
    event_days = EventDay.objects.select_related('event').order_by('date')

    return render(request, 'playlist_create.html', {
        'form': form,
        'playlist': playlist,
        'event_days': event_days,
        'selected_day_id': selected_day_id
    })
```

---

## âœ… è£œè¶³ãƒã‚¤ãƒ³ãƒˆ

- `PlaylistForm` ã¯ `ModelMultipleChoiceField` ã‚’ä½¿ã£ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ¼ãƒ ã§ã€`artists_queryset` ã‚’å¼•æ•°ã§å—ã‘å–ã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã™ï¼ˆæ¬¡ã§å®šç¾©ã§ãã¾ã™ï¼‰
- `get_top_tracks()` ã¯ Spotify API ã‹ã‚‰ä»£è¡¨æ›²ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆã™ã§ã«å®šç¾©æ¸ˆã¿ï¼‰
- `playlist_create.html` ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã¯ã€`playlist` ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåãƒ»Spotifyãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã—ã¾ã™

---

## ğŸ”œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- `forms.py` ã« `PlaylistForm` ã‚’è¿½åŠ 
- `urls.py` ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ï¼š
  ```python
  from .views.playlist_views import create_playlist_view
  path('playlist/create/', create_playlist_view, name='create_playlist')
  ```

---

ã“ã®ãƒ“ãƒ¥ãƒ¼ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸ã³ã€å‡ºæ¼”è€…ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹æµã‚ŒãŒå®Œæˆã—ã¾ã™ã€‚æ¬¡ã¯ `PlaylistForm` ã®å®šç¾©ã«é€²ã¿ã¾ã—ã‚‡ã†ï¼
ä»¥ä¸‹ã«ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆãƒ“ãƒ¥ãƒ¼ã§ä½¿ç”¨ã™ã‚‹ **`PlaylistForm`** ã‚’ `forms.py` ã«è¿½åŠ ã™ã‚‹æ§‹æˆã‚’ã”ææ¡ˆã—ã¾ã™ã€‚

---

## ğŸ§¾ `forms.py` ã«è¿½åŠ ã™ã‚‹ `PlaylistForm`

```python
from django import forms
from festival.models import Artist

class PlaylistForm(forms.Form):
    """å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆé¸æŠç”¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆï¼‰"""

    artists = forms.ModelMultipleChoiceField(
        queryset=Artist.objects.none(),
        widget=forms.CheckboxSelectMultiple,
        required=True,
        label='å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ'
    )

    def __init__(self, *args, artists_queryset=None, **kwargs):
        super().__init__(*args, **kwargs)
        if artists_queryset is not None:
            self.fields['artists'].queryset = artists_queryset
```

---

## âœ… èª¬æ˜

- `ModelMultipleChoiceField` ã‚’ä½¿ã£ã¦ã€è¤‡æ•°ã® `Artist` ã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠå¯èƒ½ã«ã—ã¦ã„ã¾ã™
- `artists_queryset` ã‚’ `__init__()` ã§å—ã‘å–ã‚Šã€ãƒ“ãƒ¥ãƒ¼å´ã‹ã‚‰å‡ºæ¼”è€…ãƒªã‚¹ãƒˆã‚’æ³¨å…¥ã™ã‚‹è¨­è¨ˆã§ã™
- `CheckboxSelectMultiple` ã«ã‚ˆã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå´ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™

---

## ğŸ”— ãƒ“ãƒ¥ãƒ¼ã¨ã®é€£æºï¼ˆå¾©ç¿’ï¼‰

```python
form = PlaylistForm(request.POST or None, artists_queryset=artists_qs)
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒˆ

- ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠã™ã‚‹ã¨ã€å‡ºæ¼”ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§è¡¨ç¤ºã•ã‚Œã‚‹
- ãƒã‚§ãƒƒã‚¯ã—ãŸã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ä»£è¡¨æ›²ãŒãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹
- æœªé¸æŠæ™‚ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ï¼ˆ`required=True`ï¼‰

---

ã“ã‚Œã§ã€ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆä½œæˆæ©Ÿèƒ½ã®ãƒ•ã‚©ãƒ¼ãƒ éƒ¨åˆ†ãŒå®Œæˆã§ã™ï¼æ¬¡ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª¿æ•´ã‚„ã€Spotifyãƒªãƒ³ã‚¯ã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ•´ãˆã‚‹æ®µéšã«é€²ã‚ã¾ã—ã‚‡ã†ã‹ï¼Ÿ
