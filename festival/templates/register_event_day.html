<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã¨å‡ºæ¼”è€…ç™»éŒ²</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
    <h1>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã¨å‡ºæ¼”è€…ç™»éŒ²</h1>

    {% if message %}
        <div class="alert alert-success">{{ message }}</div>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="event" value="{{ selected_event_id }}">

        {{ form.date }}
        {{ form.venue }}

        <!-- ğŸ” æ¤œç´¢ãƒãƒ¼ -->
        <div class="mb-3">
            <label for="artistSearch" class="form-label">å‡ºæ¼”è€…æ¤œç´¢</label>
            <input type="text" id="artistSearch" class="form-control" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›" autocomplete="off" aria-label="å‡ºæ¼”è€…æ¤œç´¢">
        </div>

        <!-- âœ… çµ„æ•°è¡¨ç¤º -->
        <div class="mb-2">
            <span id="artistCount" class="text-muted">å‡ºæ¼”è€…æ•°: 0çµ„</span>
        </div>

        {{ form.artists }}

        <button type="submit" class="btn btn-primary">ç™»éŒ²ã™ã‚‹</button>
    </form>

    <a href="{% url 'festival:event_list' %}" class="btn btn-secondary mt-3">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã«æˆ»ã‚‹</a>

    <script type="text/javascript">
        const eventData = JSON.parse('{{ event_data_json|escapejs }}' || '{}');
        const selectedEventId = "{{ selected_event_id }}";

        function updateDateOptions() {
            const dateSelect = document.getElementById("id_date");
            if (!dateSelect) return;
            dateSelect.innerHTML = "";

            if (eventData[selectedEventId]) {
                const start = new Date(eventData[selectedEventId].start);
                const end = new Date(eventData[selectedEventId].end);

                for (let d = new Date(start); d.getTime() <= new Date(end).getTime(); d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const option = document.createElement("option");
                    option.value = dateStr;
                    option.text = dateStr;
                    dateSelect.appendChild(option);
                }
            }
        }

        function sortArtistsByChecked() {
            const container = document.getElementById("id_artists");
            const items = Array.from(container.querySelectorAll("label"));
            const checked = items.filter(label => label.querySelector("input").checked);
            const unchecked = items.filter(label => !label.querySelector("input").checked);

            // ä¸¦ã³æ›¿ãˆ
            container.innerHTML = "";
            [...checked, ...unchecked].forEach(label => container.appendChild(label));
        }

        function updateArtistCount() {
            const count = document.querySelectorAll("#id_artists input[type='checkbox']:checked").length;
            document.getElementById("artistCount").textContent = `å‡ºæ¼”è€…æ•°: ${count}çµ„`;
        }

        document.addEventListener("DOMContentLoaded", function () {
            updateDateOptions();
            sortArtistsByChecked();
            updateArtistCount();

            const searchInput = document.getElementById("artistSearch");
            const artistLabels = document.querySelectorAll("#id_artists label");

            if (searchInput && artistLabels.length > 0) {
                searchInput.addEventListener("input", function () {
                    const keyword = this.value.toLowerCase();
                    artistLabels.forEach(label => {
                        const text = label.textContent.toLowerCase();
                        label.style.display = text.includes(keyword) ? "block" : "none";
                    });
                });
            }

            // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹å¤‰æ›´æ™‚ã«çµ„æ•°æ›´æ–°
            document.querySelectorAll("#id_artists input[type='checkbox']").forEach(checkbox => {
                checkbox.addEventListener("change", updateArtistCount);
            });
        });
    </script>
</body>
</html>