{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/timetable.css' %}">
{% endblock %}

{% block title %}ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º{% endblock %}

{% block content %}
<h1>ğŸª ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º</h1>

<!-- ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹é¸æŠ -->
<form method="GET" class="mb-4">
    <label for="event_day" class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã‚’é¸æŠ</label>
    <div class="input-group">
        <select name="event_day" id="event_day" class="form-select">
            {% for day in event_days %}
                <option value="{{ day.id }}" {% if day.id|stringformat:"s" == selected_day_id %}selected{% endif %}>
                    {{ day.date }} @ {{ day.venue }}
                </option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-outline-primary">è¡¨ç¤º</button>
    </div>
</form>

{% if event_day %}
    <h2 class="mt-4">{{ event_day.date }} @ {{ event_day.venue }}</h2>

    <!-- æ—¥ä»˜åˆ‡ã‚Šæ›¿ãˆãƒªãƒ³ã‚¯ -->
    <div class="mb-4">
        <span class="fw-bold">ä»–ã®æ—¥ç¨‹ï¼š</span>
        {% for day in event_days %}
            {% if day.event.id == event_day.event.id and day.id != event_day.id %}
                <a href="?event_day={{ day.id }}" class="btn btn-sm btn-outline-secondary me-2">
                    {{ day.date }}
                </a>
            {% endif %}
        {% endfor %}
    </div>

    <table class="table table-bordered timetable-grid">
        <thead>
            <tr>
                <th>æ™‚é–“</th>
                {% for stage in stages %}
                    <th style="background-color: {{ stage.color_code }};">{{ stage.name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for time in time_slots %}
                <tr>
                    <td class="time-cell">
                        {% if time.minute == 0 %}
                            {{ time|time:"H:i" }}
                        {% endif %}
                    </td>
                    {% for stage in stages %}
                        {% with perf_list=performances_by_stage_and_time|get_item:stage.id|get_item:time %}
                            {% if perf_list %}
                                <td>
                                    {% for perf in perf_list %}
                                        {% if first_slot_map|get_item:perf == time %}
                                            <div class="artist-block" style="background-color: {{ stage.color_code }};">
                                                {{ perf.artist.name }}{{ perf.start_time|time:"H:i" }} - {{ perf.end_time|time:"H:i" }}
                                                {% if request.user.is_staff %}
                                                    <a href="{% url 'festival:edit_performance' perf.id %}" class="btn btn-sm btn-outline-primary edit-btn">ç·¨é›†</a>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <div class="artist-block muted-block" style="background-color: {{ stage.color_code }};">&nbsp;</div>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            {% else %}
                                <td></td>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}

<a href="{% url 'festival:event_list' %}" class="btn btn-secondary mt-4">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã¸æˆ»ã‚‹</a>
{% endblock %}