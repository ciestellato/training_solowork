{% extends 'base.html' %}

{% block title %}ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã¨å‡ºæ¼”è€…ç·¨é›†{% endblock %}

{% block content %}
<h1>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆæ—¥ç¨‹ã¨å‡ºæ¼”è€…ç·¨é›†</h1>

{% if message %}
    <div class="alert alert-success">{{ message }}</div>
{% endif %}

<h2>{{ event.name }} - {{ event_day.date }} ã®å‡ºæ¼”è€…ç·¨é›†</h2>

<form method="post">
    {% csrf_token %}

    <div class="mb-3">
        <label class="form-label">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
        <input type="text" class="form-control" value="{{ event.name }}" readonly>
    </div>

    <input type="hidden" name="event" value="{{ event.id }}">

    <div class="mb-3">
        <label for="artistSearch" class="form-label">å‡ºæ¼”è€…æ¤œç´¢</label>
        <input type="text" id="artistSearch" class="form-control" placeholder="åå‰ã§çµã‚Šè¾¼ã¿">
    </div>

    {{ form.as_p }}

    <button type="submit" class="btn btn-primary">æ›´æ–°</button>
</form>

<a href="{% url 'festival:event_detail' event.id %}" class="btn btn-secondary mt-3">â† ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ã«æˆ»ã‚‹</a>

<script type="text/javascript">
    const eventData = JSON.parse('{{ event_data_json|escapejs }}' || '{}');
    const selectedEventId = "{{ selected_event_id }}";
    const initialDate = "{{ event_day.date|date:'Y-m-d' }}";

    function updateDateOptions() {
        const dateSelect = document.getElementById("id_date");
        dateSelect.innerHTML = "";

        if (eventData[selectedEventId]) {
            const start = new Date(eventData[selectedEventId].start);
            const end = new Date(eventData[selectedEventId].end);

            for (let d = new Date(start); d.getTime() <= end.getTime(); d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const option = document.createElement("option");
                option.value = dateStr;
                option.text = dateStr;

                if (dateStr === initialDate) {
                    option.selected = true;
                }

                dateSelect.appendChild(option);
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        updateDateOptions();

        const eventField = document.getElementById("id_event");
        if (eventField) {
            eventField.disabled = true;
        }

        const searchInput = document.getElementById("artistSearch");
        const artistLabels = document.querySelectorAll("#id_artists label");

        if (searchInput && artistLabels.length > 0) {
            searchInput.addEventListener("input", function () {
                const keyword = this.value.toLowerCase();

                artistLabels.forEach(label => {
                    const text = label.textContent.toLowerCase();
                    const parentDiv = label.closest("div");
                    if (parentDiv) {
                        parentDiv.style.display = text.includes(keyword) ? "block" : "none";
                    }
                });
            });
        }
    });
</script>
{% endblock %}